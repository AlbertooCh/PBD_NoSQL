<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoSQL Benchmark: Mongo vs Redis vs Riak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 1s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <!-- MEN√ö LATERAL -->
    <aside class="w-64 bg-black border-r border-slate-800 flex flex-col z-20">
        <div class="p-6 border-b border-slate-900 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
            <h1 class="font-bold text-lg tracking-wider text-white">NoSQL <span class="text-blue-500">LAB</span></h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">General</div>
            <button onclick="showSection('welcome')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè† <span>Inicio</span>
            </button>
            <button onclick="loadData()" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-green-400">
                üíæ <span>Cargar Datos</span>
            </button>
            <button onclick="showSection('benchmark')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-yellow-400 border border-transparent hover:border-yellow-900">
                üöÄ <span>Comparativa</span>
            </button>

            <div class="mt-6 text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">CRUD B√°sico</div>
            <button onclick="loadOperation('listar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üìú <span>Listar Todo</span>
            </button>
            <button onclick="loadOperation('leer')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üëÅÔ∏è <span>Leer (Por ID)</span>
            </button>
            <button onclick="loadOperation('insertar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚ûï <span>Insertar Nuevo</span>
            </button>
            <button onclick="loadOperation('actualizar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚úèÔ∏è <span>Actualizar</span>
            </button>
            <button onclick="loadOperation('borrar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-red-400">
                üóëÔ∏è <span>Borrar</span>
            </button>

            <div class="mt-6 text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">Consultas Avanzadas</div>
            <button onclick="loadOperation('indexar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè∑Ô∏è <span>Indexar (2i)</span>
            </button>
            <button onclick="loadOperation('rango')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üîç <span>B√∫squeda Rango</span>
            </button>
            <button onclick="loadOperation('filtro')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚ö° <span>Filtro Complejo</span>
            </button>
            <button onclick="loadOperation('agregacion')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üìä <span>Agregaci√≥n</span>
            </button>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900">

        <!-- BIENVENIDA -->
        <div id="welcome-view" class="absolute inset-0 flex flex-col items-center justify-center text-center p-10 fade-in z-10">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent text-7xl font-extrabold mb-6">
                NoSQL Operations
            </div>
            <p class="text-xl text-slate-400 max-w-2xl mb-10">
                Explora las operaciones b√°sicas (CRUD) y avanzadas en MongoDB, Redis y Riak.
            </p>
            <div class="grid grid-cols-3 gap-6 w-full max-w-4xl">
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-green-400 font-bold">MongoDB</h3><p class="text-xs text-slate-500">Document Store</p></div>
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-red-400 font-bold">Redis</h3><p class="text-xs text-slate-500">In-Memory KV</p></div>
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-orange-400 font-bold">Riak</h3><p class="text-xs text-slate-500">Distributed KV</p></div>
            </div>
        </div>

        <!-- BENCHMARK -->
        <div id="benchmark-view" class="hidden absolute inset-0 flex flex-col p-8 fade-in z-10 bg-slate-900">
            <h2 class="text-3xl font-bold text-white mb-6">üöÄ Test de Rendimiento</h2>
            <div class="bg-slate-800 rounded-xl p-6 mb-6">
                <div class="flex gap-4">
                    <button onclick="runBenchmark('insertar')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Insertar</button>
                    <button onclick="runBenchmark('leer')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Lectura ID</button>
                    <button onclick="runBenchmark('rango')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Rango 2i</button>
                </div>
            </div>
            <div class="flex-1 space-y-6">
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-red-400">REDIS</span><span id="bench-time-redis" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-redis" class="h-full bg-red-500 progress-bar w-0"></div></div></div>
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-green-400">MONGO</span><span id="bench-time-mongo" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-mongo" class="h-full bg-green-500 progress-bar w-0"></div></div></div>
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-orange-400">RIAK</span><span id="bench-time-riak" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-riak" class="h-full bg-orange-500 progress-bar w-0"></div></div></div>
            </div>
        </div>

        <!-- VISTA OPERACIONES -->
        <div id="operation-view" class="hidden flex-1 flex flex-col h-full">
            <header class="bg-slate-950 border-b border-slate-800 p-6 flex justify-between items-center">
                <div>
                    <h2 id="op-title" class="text-2xl font-bold text-white">Operaci√≥n</h2>
                    <p id="op-subtitle" class="text-slate-400 text-sm">Descripci√≥n...</p>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-800">
                    <button onclick="selectDB('mongo')" id="tab-mongo" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">MongoDB</button>
                    <button onclick="selectDB('redis')" id="tab-redis" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Redis</button>
                    <button onclick="selectDB('riak')" id="tab-riak" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Riak</button>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 flex flex-col border-r border-slate-800 bg-slate-900">
                    <div class="p-6 border-b border-slate-800 bg-slate-800/30">
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-3">üõ†Ô∏è Par√°metros</h3>
                        <div id="input-container" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <h3 class="text-slate-500 font-bold uppercase text-xs tracking-widest mb-2">C√≥digo:</h3>
                        <p id="op-explanation" class="text-slate-300 mb-4 text-sm leading-relaxed"></p>
                        <div class="relative group">
                            <pre><code id="op-code" class="language-python rounded-lg bg-black p-4 text-sm border border-slate-700 shadow-inner"></code></pre>
                        </div>
                        <button onclick="runExecution()" id="btn-run" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98] flex justify-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Ejecutar en <span id="btn-db-name">...</span>
                        </button>
                    </div>
                </div>
                <div class="w-1/2 bg-black flex flex-col font-mono text-sm">
                    <div class="bg-slate-900 text-slate-400 px-4 py-2 text-xs border-b border-slate-800 flex justify-between">
                        <span>TERMINAL</span>
                        <span id="exec-time" class="text-yellow-500"></span>
                    </div>
                    <div id="console-output" class="flex-1 p-4 overflow-y-auto space-y-1 text-green-400 font-light"></div>
                    <div class="h-1/3 border-t border-slate-800 bg-slate-900/50 flex flex-col">
                        <div class="bg-slate-900 text-slate-400 px-4 py-1 text-xs border-b border-slate-800">JSON RAW</div>
                        <div id="json-output" class="flex-1 p-4 overflow-auto text-blue-300 text-xs whitespace-pre">{}</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8000";
        let currentOp = null;
        let currentDB = 'mongo';

        const KNOWLEDGE = {
            // --- CRUD B√ÅSICO ---
            listar: {
                title: "Listar Todo",
                subtitle: "Obtener todas las claves/documentos de una colecci√≥n.",
                inputs: [],
                mongo: { desc: "Scan completo de colecci√≥n.", code: `db.poblacion.find({})` },
                redis: { desc: "Comando SCAN (iterador) o KEYS * (peligroso en prod).", code: `SCAN 0 MATCH poblacion:*` },
                riak: { desc: "Obtener lista de claves (costoso) y luego iterar objetos.", code: `keys = bucket.get_keys()\nfor k in keys:\n  print(bucket.get(k).data)` }
            },
            leer: {
                title: "Leer por ID",
                subtitle: "Recuperar un objeto espec√≠fico usando su Clave Primaria (DNI).",
                inputs: [{id: 'dni', label: 'DNI a buscar', type: 'text', val: '555888999'}],
                mongo: { desc: "B√∫squeda directa por campo indexado.", code: `db.poblacion.findOne({ dni: "{{dni}}" })` },
                redis: { desc: "Acceso O(1) a Hash.", code: `HGETALL poblacion:{{dni}}` },
                riak: { desc: "GET HTTP directo a la key.", code: `get_object('poblacion', '{{dni}}')` }
            },
            insertar: {
                title: "Insertar Nuevo",
                subtitle: "Crear un nuevo registro.",
                inputs: [
                    {id: 'dni', label: 'DNI', type: 'text', val: '555888999'},
                    {id: 'nombre', label: 'Nombre', type: 'text', val: 'Laura'},
                    {id: 'ingresos', label: 'Ingresos', type: 'number', val: 30000},
                    {id: 'sector', label: 'Sector', type: 'number', val: 2}
                ],
                mongo: { desc: "Insertar documento JSON.", code: `db.poblacion.insertOne({\n  dni: "{{dni}}",\n  nombre: "{{nombre}}", ...\n})` },
                redis: { desc: "Crear Hash con campos.", code: `HSET poblacion:{{dni}} nombre "{{nombre}}" ...` },
                riak: { desc: "PUT a la clave. ¬°Importante a√±adir √≠ndices manualmente!", code: `data = { ... }\nidxs = {'ingresos_int': {{ingresos}} ...}\nstore_object('poblacion', '{{dni}}', data, idxs)` }
            },
            actualizar: {
                title: "Actualizar",
                subtitle: "Modificar un registro existente (Simulamos cambio de ingresos).",
                inputs: [{id: 'dni', label: 'DNI a editar', type: 'text', val: '555888999'}],
                mongo: { desc: "Update at√≥mico in-place.", code: `db.poblacion.updateOne(\n  { dni: "{{dni}}" },\n  { $inc: { ingresos: 5000 } }\n)` },
                redis: { desc: "Sobrescribir campo en Hash.", code: `HSET poblacion:{{dni}} ingresos NEW_VAL` },
                riak: { desc: "Fetch -> Modify -> Store (Sobrescribe todo el objeto).", code: `obj = bucket.get('{{dni}}')\nobj.data['ingresos'] += 5000\nobj.store()` }
            },
            borrar: {
                title: "Borrar",
                subtitle: "Eliminar un registro permanentemente.",
                inputs: [{id: 'dni', label: 'DNI a borrar', type: 'text', val: '555888999'}],
                mongo: { desc: "Delete one document.", code: `db.poblacion.deleteOne({ dni: "{{dni}}" })` },
                redis: { desc: "Eliminar clave.", code: `DEL poblacion:{{dni}}` },
                riak: { desc: "Delete HTTP.", code: `bucket.delete('{{dni}}')` }
            },
            // --- AVANZADO (Ya existente) ---
            indexar: {
                title: "Indexar Datos (2i)",
                subtitle: "Recalcular √≠ndices para b√∫squedas.",
                inputs: [],
                mongo: { desc: "Crear √≠ndices B-Tree.", code: `db.poblacion.createIndex({ingresos:1})` },
                redis: { desc: "Crear √≠ndice RediSearch.", code: `FT.CREATE ...` },
                riak: { desc: "Recorrer todos los objetos y hacer PUT con headers.", code: `for k in keys: store_with_headers(...)` }
            },
            rango: {
                title: "B√∫squeda Rango",
                subtitle: "Filtrar por rango de ingresos.",
                inputs: [{id: 'min_val', label: 'Min', type: 'number', val: 20000}, {id: 'max_val', label: 'Max', type: 'number', val: 50000}],
                mongo: { desc: "$gte y $lte.", code: `find({ ingresos: { $gte: {{min_val}}, $lte: {{max_val}} } })` },
                redis: { desc: "Query num√©rica.", code: `FT.SEARCH ... @ingresos:[{{min_val}} {{max_val}}]` },
                riak: { desc: "2i Range Query.", code: `bucket.get_index('ingresos_int', {{min_val}}, {{max_val}})` }
            },
            filtro: {
                title: "Filtro Complejo",
                subtitle: "Sector AND Sexo.",
                inputs: [{id: 'sector', label: 'Sector', type: 'number', val: 2}, {id: 'sexo', label: 'Sexo', type: 'select', val: 'M', opts:['H','M']}],
                mongo: { desc: "Query compuesta.", code: `find({ sector: {{sector}}, sexo: "{{sexo}}" })` },
                redis: { desc: "Intersecci√≥n √≠ndices.", code: `FT.SEARCH ... @sector:[{{sector}} {{sector}}] ...` },
                riak: { desc: "App Side Join.", code: `keys = get_index('sector', {{sector}})\nresults = [get(k) for k in keys if k.sexo=='{{sexo}}']` }
            },
            agregacion: {
                title: "Agregaci√≥n",
                subtitle: "Suma ingresos por sector.",
                inputs: [{id: 'sector', label: 'Sector', type: 'number', val: 2}],
                mongo: { desc: "Pipeline.", code: `aggregate([{ $match... $group... }])` },
                redis: { desc: "FT.AGGREGATE.", code: `FT.AGGREGATE ... REDUCE SUM ...` },
                riak: { desc: "C√°lculo en cliente.", code: `total = sum(obj.ingresos for obj in sector_{{sector}})` }
            }
        };

        function showSection(id) {
            ['welcome-view', 'benchmark-view', 'operation-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id + '-view').classList.remove('hidden');
        }

        async function loadData() {
            if(!confirm("Se reiniciar√°n los datos. ¬øContinuar?")) return;
            const res = await fetch(`${API_URL}/load-data`);
            alert((await res.json()).msg);
        }

        function loadOperation(op) {
            currentOp = op;
            showSection('operation');
            const info = KNOWLEDGE[op];
            document.getElementById('op-title').innerText = info.title;
            document.getElementById('op-subtitle').innerText = info.subtitle;
            renderInputs(info.inputs);
            selectDB(currentDB);
        }

        function renderInputs(inputs) {
            const container = document.getElementById('input-container');
            container.innerHTML = '';
            if(!inputs.length) container.innerHTML = '<div class="text-xs text-slate-500 italic">Sin par√°metros</div>';
            inputs.forEach(inp => {
                const div = document.createElement('div');
                div.className = "flex flex-col";
                const label = document.createElement('label');
                label.className = "text-xs text-slate-400 mb-1 font-bold";
                label.innerText = inp.label;
                let field;
                if(inp.type === 'select') {
                    field = document.createElement('select');
                    inp.opts.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o; opt.innerText = o;
                        if(o === inp.val) opt.selected = true;
                        field.appendChild(opt);
                    });
                } else {
                    field = document.createElement('input');
                    field.type = inp.type; field.value = inp.val;
                }
                field.id = `input-${inp.id}`;
                field.className = "bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none";
                field.addEventListener('input', updateCodeView);
                field.addEventListener('change', updateCodeView);
                div.appendChild(label); div.appendChild(field); container.appendChild(div);
            });
        }

        function getParamValues() {
            if(!currentOp || !KNOWLEDGE[currentOp].inputs) return {};
            const vals = {};
            KNOWLEDGE[currentOp].inputs.forEach(inp => vals[inp.id] = document.getElementById(`input-${inp.id}`).value);
            return vals;
        }

        function updateCodeView() {
            const info = KNOWLEDGE[currentOp][currentDB];
            let code = info.code;
            const params = getParamValues();
            for (const [key, val] of Object.entries(params)) code = code.replaceAll(`{{${key}}}`, val);
            document.getElementById('op-explanation').innerText = info.desc;
            const codeEl = document.getElementById('op-code');
            codeEl.textContent = code;
            hljs.highlightElement(codeEl);
        }

        function selectDB(db) {
            currentDB = db;
            document.querySelectorAll('.tab-btn').forEach(b => b.id === `tab-${db}` ? b.classList.add('bg-blue-600', 'text-white') : b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById('btn-db-name').innerText = db.toUpperCase();
            updateCodeView();
            document.getElementById('console-output').innerHTML = '';
            document.getElementById('json-output').innerText = '{}';
        }

        async function runExecution() {
            const params = new URLSearchParams(getParamValues());
            const url = `${API_URL}/execute/${currentOp}/${currentDB}?${params}`;
            document.getElementById('console-output').innerHTML = '<div class="text-yellow-500 animate-pulse">‚è≥ Procesando...</div>';
            try {
                const res = await fetch(url);
                const data = await res.json();
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerHTML = '';
                data.trace.forEach(l => { const d=document.createElement('div'); d.innerText=l; consoleDiv.appendChild(d); });
                document.getElementById('json-output').innerText = JSON.stringify(data.data, null, 2);
                document.getElementById('exec-time').innerText = `${data.time_ms} ms`;
            } catch(e) { alert("Error backend"); }
        }

        async function runBenchmark(op) {
            ['redis','mongo','riak'].forEach(db => { document.getElementById(`bench-bar-${db}`).style.width='0%'; document.getElementById(`bench-time-${db}`).innerText='...'; });
            const params = new URLSearchParams({ min_val:20000, max_val:50000, sector:2, sexo:'M', dni:'555888999', nombre:'BenchUser', ingresos:30000 });
            const results = [];
            for (const db of ['redis','mongo','riak']) {
                const res = await fetch(`${API_URL}/execute/${op}/${db}?${params}`);
                const data = await res.json();
                results.push({db, time: data.time_ms});
                document.getElementById(`bench-time-${db}`).innerText = `${data.time_ms} ms`;
            }
            const max = Math.max(...results.map(r=>r.time));
            results.forEach(r => document.getElementById(`bench-bar-${r.db}`).style.width = `${(r.time/max)*100}%`);
        }
    </script>
</body>
</html>
