<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoSQL Benchmark: Mongo vs Redis vs Riak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 1s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <!-- MEN√ö LATERAL -->
    <aside class="w-64 bg-black border-r border-slate-800 flex flex-col z-20">
        <div class="p-6 border-b border-slate-900 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
            <h1 class="font-bold text-lg tracking-wider text-white">NoSQL <span class="text-blue-500">LAB</span></h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">General</div>
            <button onclick="showSection('welcome')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè† <span>Inicio</span>
            </button>
            <button onclick="loadData()" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-green-400">
                üíæ <span>Cargar Datos</span>
            </button>
            <button onclick="showSection('benchmark')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-yellow-400 border border-transparent hover:border-yellow-900">
                üöÄ <span>Comparativa</span>
            </button>

            <div class="mt-6 text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">CRUD B√°sico</div>
            <button onclick="loadOperation('listar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üìú <span>Listar Todo</span>
            </button>
            <button onclick="loadOperation('leer')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üëÅÔ∏è <span>Leer (Por ID)</span>
            </button>
            <button onclick="loadOperation('insertar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚ûï <span>Insertar Nuevo</span>
            </button>
            <button onclick="loadOperation('actualizar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚úèÔ∏è <span>Actualizar</span>
            </button>
            <button onclick="loadOperation('borrar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-red-400">
                üóëÔ∏è <span>Borrar</span>
            </button>

            <div class="mt-6 text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">Consultas Avanzadas</div>
            <button onclick="loadOperation('indexar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè∑Ô∏è <span>Indexar (Optimizaci√≥n)</span>
            </button>
            <button onclick="loadOperation('rango')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üîç <span>B√∫squeda Rango</span>
            </button>
            <button onclick="loadOperation('filtro')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚ö° <span>Filtro Complejo</span>
            </button>
            <button onclick="loadOperation('agregacion')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üìä <span>Agregaci√≥n</span>
            </button>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900">

        <!-- BIENVENIDA -->
        <div id="welcome-view" class="absolute inset-0 flex flex-col items-center justify-center text-center p-10 fade-in z-10">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent text-7xl font-extrabold mb-6">
                NoSQL Operations
            </div>
            <p class="text-xl text-slate-400 max-w-2xl mb-10">
                Plataforma interactiva para MongoDB, Redis Stack y Riak KV.
            </p>
            <div class="grid grid-cols-3 gap-6 w-full max-w-4xl">
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-green-400 font-bold">MongoDB</h3><p class="text-xs text-slate-500">Documental</p></div>
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-red-400 font-bold">Redis</h3><p class="text-xs text-slate-500">JSON + RediSearch</p></div>
                <div class="p-6 bg-slate-800/50 rounded-xl border border-slate-800"><h3 class="text-orange-400 font-bold">Riak</h3><p class="text-xs text-slate-500">Key-Value + 2i</p></div>
            </div>
        </div>

        <!-- BENCHMARK -->
        <div id="benchmark-view" class="hidden absolute inset-0 flex flex-col p-8 fade-in z-10 bg-slate-900">
            <h2 class="text-3xl font-bold text-white mb-6">üöÄ Test de Rendimiento</h2>
            <div class="bg-slate-800 rounded-xl p-6 mb-6">
                <div class="flex gap-4">
                    <button onclick="runBenchmark('insertar')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Insertar</button>
                    <button onclick="runBenchmark('leer')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Lectura ID</button>
                    <button onclick="runBenchmark('rango')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Rango</button>
                </div>
            </div>
            <div class="flex-1 space-y-6">
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-red-400">REDIS</span><span id="bench-time-redis" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-redis" class="h-full bg-red-500 progress-bar w-0"></div></div></div>
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-green-400">MONGO</span><span id="bench-time-mongo" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-mongo" class="h-full bg-green-500 progress-bar w-0"></div></div></div>
                <div class="relative"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-orange-400">RIAK</span><span id="bench-time-riak" class="text-slate-400">0 ms</span></div><div class="h-8 bg-slate-800 rounded-full overflow-hidden"><div id="bench-bar-riak" class="h-full bg-orange-500 progress-bar w-0"></div></div></div>
            </div>
        </div>

        <!-- VISTA OPERACIONES -->
        <div id="operation-view" class="hidden flex-1 flex flex-col h-full">
            <header class="bg-slate-950 border-b border-slate-800 p-6 flex justify-between items-center">
                <div>
                    <h2 id="op-title" class="text-2xl font-bold text-white">Operaci√≥n</h2>
                    <p id="op-subtitle" class="text-slate-400 text-sm">Descripci√≥n...</p>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-800">
                    <button onclick="selectDB('mongo')" id="tab-mongo" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">MongoDB</button>
                    <button onclick="selectDB('redis')" id="tab-redis" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Redis</button>
                    <button onclick="selectDB('riak')" id="tab-riak" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Riak</button>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 flex flex-col border-r border-slate-800 bg-slate-900">
                    <div class="p-6 border-b border-slate-800 bg-slate-800/30">
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-3">üõ†Ô∏è Par√°metros</h3>
                        <div id="input-container" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <h3 class="text-slate-500 font-bold uppercase text-xs tracking-widest mb-2">C√≥digo (Python Driver):</h3>
                        <p id="op-explanation" class="text-slate-300 mb-4 text-sm leading-relaxed"></p>
                        <div class="relative group">
                            <pre><code id="op-code" class="language-python rounded-lg bg-black p-4 text-sm border border-slate-700 shadow-inner"></code></pre>
                        </div>
                        <button onclick="runExecution()" id="btn-run" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98] flex justify-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Ejecutar en <span id="btn-db-name">...</span>
                        </button>
                    </div>
                </div>
                <div class="w-1/2 bg-black flex flex-col font-mono text-sm">
                    <div class="bg-slate-900 text-slate-400 px-4 py-2 text-xs border-b border-slate-800 flex justify-between">
                        <span>TERMINAL</span>
                        <span id="exec-time" class="text-yellow-500"></span>
                    </div>
                    <div id="console-output" class="flex-1 p-4 overflow-y-auto space-y-1 text-green-400 font-light"></div>
                    <div class="h-1/3 border-t border-slate-800 bg-slate-900/50 flex flex-col">
                        <div class="bg-slate-900 text-slate-400 px-4 py-1 text-xs border-b border-slate-800">JSON RAW</div>
                        <div id="json-output" class="flex-1 p-4 overflow-auto text-blue-300 text-xs whitespace-pre">{}</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8000";
        let currentOp = null;
        let currentDB = 'mongo';

        const KNOWLEDGE = {
            // --- CRUD B√ÅSICO ---
            listar: {
                title: "Listar Todo",
                subtitle: "Obtener todas las claves/documentos.",
                inputs: [],
                mongo: { desc: "Scan completo.", code: `db.poblacion.find({})` },
                redis: {
                    desc: "Obtener todas las claves y luego sus valores JSON.",
                    code: `keysPob = r.keys("poblacion:*")\nfor k in keysPob:\n  registro = r.json().get(k)\n  print(registro)`
                },
                riak: { desc: "Obtener keys + get.", code: `keys = bucket.get_keys()\nfor k in keys: get(k)` }
            },
            leer: {
                title: "Leer por ID",
                subtitle: "Recuperar objeto por su clave.",
                inputs: [{id: 'dni', label: 'DNI', type: 'text', val: '555888999'}],
                mongo: { desc: "Find one.", code: `findOne({dni: '{{dni}}'})` },
                redis: { desc: "JSON.GET directo.", code: `r.json().get("poblacion:{{dni}}")` },
                riak: { desc: "Get directo.", code: `bucket.get('{{dni}}')` }
            },
            insertar: {
                title: "Insertar (Pub/Sub)",
                subtitle: "Insertar JSON y notificar evento.",
                inputs: [{id: 'dni', label: 'DNI', type: 'text', val: '555888999'}, {id: 'nombre', label: 'Nombre', type: 'text', val: 'Laura'}, {id: 'ingresos', label: 'Ingresos', type: 'number', val: 30000}],
                mongo: {
                    desc: "Insert One con Trigger autom√°tico en Atlas.",
                    code: `try:\n  db.poblacion.insert_one(p)\n  print(f"Insertado {p['_id']}")\nexcept DuplicateKeyError:\n  print("Duplicado")`
                },
                redis: {
                    desc: "Guardar JSON y publicar mensaje al canal 'nueva_persona'.",
                    code: `p = { "dni": "{{dni}}", "nombre": "{{nombre}}" ... }\n# 1. Guardar\nr.json().set(f"poblacion:{p['dni']}", Path.root_path(), p)\n# 2. Notificar\nr.publish("nueva_persona", f"Se ha unido {p['nombre']}")`
                },
                riak: { desc: "Store + √çndices.", code: `store(..., indexes={...})` }
            },
            actualizar: {
                title: "Actualizar (Parcial)",
                subtitle: "Modificar un campo espec√≠fico del JSON.",
                inputs: [{id: 'dni', label: 'DNI', type: 'text', val: '555888999'}],
                mongo: { desc: "Update One.", code: `updateOne(...)` },
                redis: {
                    desc: "JSON.SET en un path espec√≠fico ($.ingresos).",
                    code: `r.json().set("poblacion:{{dni}}", "$.ingresos", 16000)\nr.json().set("poblacion:{{dni}}", "$.direccion", "C. Actualizada")`
                },
                riak: { desc: "Fetch -> Modify -> Store.", code: `obj = get(); obj.ingresos=...; put(obj)` }
            },
            borrar: {
                title: "Borrar",
                subtitle: "Eliminar clave.",
                inputs: [{id: 'dni', label: 'DNI', type: 'text', val: '555888999'}],
                mongo: { desc: "Delete one.", code: `deleteOne(...)` },
                redis: { desc: "Borrado simple.", code: `r.delete("poblacion:{{dni}}")` },
                riak: { desc: "Delete.", code: `delete(...)` }
            },
            // --- AVANZADO ---
            indexar: {
                title: "Crear √çndice",
                subtitle: "Optimizaci√≥n de consultas.",
                inputs: [],
                mongo: {
                    desc: "√çndices B-Tree simples y compuestos.",
                    code: `db.poblacion.create_index([("ingresos", ASCENDING)])\n# Indice compuesto\ndb.poblacion.create_index([("sector", ASCENDING), ("sexo", ASCENDING)])`
                },
                redis: {
                    desc: "Crear √≠ndice sobre campos JSON (FT.CREATE).",
                    code: `schema = (\n  TextField("$.nombre", as_name="nombre"),\n  NumericField("$.ingresos", as_name="ingresos"),\n  ...\n)\nr.ft("idx_poblacion").create_index(\n  schema,\n  definition=IndexDefinition(prefix=["poblacion:"], index_type=IndexType.JSON)\n)`
                },
                riak: { desc: "Re-indexar (headers).", code: `put_with_headers(...)` }
            },
            rango: {
                title: "B√∫squeda Rango",
                subtitle: "Operadores de comparaci√≥n.",
                inputs: [{id: 'min_val', label: 'Min', type: 'number', val: 20000}, {id: 'max_val', label: 'Max', type: 'number', val: 50000}],
                mongo: {
                    desc: "Operadores $gte y $lte con proyecci√≥n.",
                    code: `query = {"ingresos": {"$gte": {{min_val}}, "$lte": {{max_val}}}}\nprojection = {"_id": 1, "nombre": 1, ...}\nres = db.poblacion.find(query, projection)`
                },
                redis: {
                    desc: "Query con sintaxis @campo:[min max].",
                    code: `q = Query("@ingresos:[{{min_val}} {{max_val}}]").paging(0, 100)\nres = r.ft("idx_poblacion").search(q)\nfor doc in res.docs: ...`
                },
                riak: { desc: "2i Range.", code: `get_index(...)` }
            },
            filtro: {
                title: "Filtro Complejo",
                subtitle: "Sector AND Sexo.",
                inputs: [{id: 'sector', label: 'Sector', type: 'number', val: 2}, {id: 'sexo', label: 'Sexo', type: 'select', val: 'M', opts:['H','M']}],
                mongo: {
                    desc: "B√∫squeda exacta (usa √≠ndice compuesto).",
                    code: `query = {"sector": {{sector}}, "sexo": "{{sexo}}"}\nres = db.poblacion.find(query)`
                },
                redis: {
                    desc: "Intersecci√≥n de filtros en la Query string.",
                    code: `q = Query("@sector:[{{sector}} {{sector}}] @sexo:{{sexo}}")\nres = r.ft("idx_poblacion").search(q)`
                },
                riak: { desc: "App Side Join.", code: `...` }
            },
            agregacion: {
                title: "Agregaci√≥n",
                subtitle: "Suma de ingresos por sector.",
                inputs: [{id: 'sector', label: 'Sector', type: 'number', val: 2}],
                mongo: {
                    desc: "Pipeline con persistencia ($out/insert).",
                    code: `pipeline = [\n  {"$group": {\n    "_id": "$sector",\n    "totalIngresos": {"$sum": "$ingresos"}\n  }},\n  {"$sort": {"_id": 1}}\n]\nres = db.poblacion.aggregate(pipeline)\ndb.resumen_sector.insert_many(res)`
                },
                redis: {
                    desc: "Iterar claves y guardar resumen en un Hash separado.",
                    code: `keys = r.keys("poblacion:*")\nresumen = {}\nfor k in keys:\n  p = r.json().get(k)\n  s = p.get('sector')\n  resumen[s] += p.get('ingresos')\n\n# Guardar resultado\nr.hset("resumen_sector", str(s), total)`
                },
                riak: { desc: "Iterar keys.", code: `...` }
            }
        };

        function showSection(id) {
            ['welcome-view', 'benchmark-view', 'operation-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id + '-view').classList.remove('hidden');
        }

        async function loadData() {
            if(!confirm("Se borrar√°n y recargar√°n datos. ¬øSeguro?")) return;
            const res = await fetch(`${API_URL}/load-data`);
            alert((await res.json()).msg);
        }

        function loadOperation(op) {
            currentOp = op;
            showSection('operation');
            const info = KNOWLEDGE[op];
            document.getElementById('op-title').innerText = info.title;
            document.getElementById('op-subtitle').innerText = info.subtitle;
            renderInputs(info.inputs);
            selectDB(currentDB);
        }

        function renderInputs(inputs) {
            const container = document.getElementById('input-container');
            container.innerHTML = '';
            if(!inputs.length) container.innerHTML = '<div class="text-xs text-slate-500 italic">Sin par√°metros</div>';
            inputs.forEach(inp => {
                const div = document.createElement('div');
                div.className = "flex flex-col";
                const label = document.createElement('label');
                label.className = "text-xs text-slate-400 mb-1 font-bold";
                label.innerText = inp.label;
                let field;
                if(inp.type === 'select') {
                    field = document.createElement('select');
                    inp.opts.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o; opt.innerText = o;
                        if(o === inp.val) opt.selected = true;
                        field.appendChild(opt);
                    });
                } else {
                    field = document.createElement('input');
                    field.type = inp.type; field.value = inp.val;
                }
                field.id = `input-${inp.id}`;
                field.className = "bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none";
                field.addEventListener('input', updateCodeView);
                field.addEventListener('change', updateCodeView);
                div.appendChild(label); div.appendChild(field); container.appendChild(div);
            });
        }

        function getParamValues() {
            if(!currentOp || !KNOWLEDGE[currentOp].inputs) return {};
            const vals = {};
            KNOWLEDGE[currentOp].inputs.forEach(inp => vals[inp.id] = document.getElementById(`input-${inp.id}`).value);
            return vals;
        }

        function updateCodeView() {
            const info = KNOWLEDGE[currentOp][currentDB];
            let code = info.code;
            const params = getParamValues();
            for (const [key, val] of Object.entries(params)) code = code.replaceAll(`{{${key}}}`, val);
            document.getElementById('op-explanation').innerText = info.desc;
            const codeEl = document.getElementById('op-code');
            codeEl.textContent = code;
            hljs.highlightElement(codeEl);
        }

        function selectDB(db) {
            currentDB = db;
            document.querySelectorAll('.tab-btn').forEach(b => b.id === `tab-${db}` ? b.classList.add('bg-blue-600', 'text-white') : b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById('btn-db-name').innerText = db.toUpperCase();
            updateCodeView();
            document.getElementById('console-output').innerHTML = '';
            document.getElementById('json-output').innerText = '{}';
        }

        async function runExecution() {
            const paramsObj = getParamValues();
            // Filter empty values to prevent 422 on optional ints
            const cleanParams = {};
            for (const [key, val] of Object.entries(paramsObj)) {
                if (val !== "") cleanParams[key] = val;
            }
            const params = new URLSearchParams(cleanParams);

            const url = `${API_URL}/execute/${currentOp}/${currentDB}?${params}`;
            document.getElementById('console-output').innerHTML = '<div class="text-yellow-500 animate-pulse">‚è≥ Procesando...</div>';

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(`Error ${res.status}: ${JSON.stringify(err.detail || err)}`);
                }
                const data = await res.json();
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerHTML = '';
                data.trace.forEach(l => { const d=document.createElement('div'); d.innerText=l; consoleDiv.appendChild(d); });
                document.getElementById('json-output').innerText = JSON.stringify(data.data, null, 2);
                document.getElementById('exec-time').innerText = `${data.time_ms} ms`;
            } catch(e) {
                document.getElementById('console-output').innerHTML = `<div class="text-red-500 font-bold">‚ùå ${e.message}</div>`;
            }
        }

        async function runBenchmark(op) {
            ['redis','mongo','riak'].forEach(db => { document.getElementById(`bench-bar-${db}`).style.width='0%'; document.getElementById(`bench-time-${db}`).innerText='...'; });
            const params = new URLSearchParams({ min_val:20000, max_val:50000, sector:2, sexo:'M', dni:'555888999', nombre:'BenchUser', ingresos:30000 });
            const results = [];
            for (const db of ['redis','mongo','riak']) {
                const res = await fetch(`${API_URL}/execute/${op}/${db}?${params}`);
                const data = await res.json();
                results.push({db, time: data.time_ms});
                document.getElementById(`bench-time-${db}`).innerText = `${data.time_ms} ms`;
            }
            const max = Math.max(...results.map(r=>r.time));
            results.forEach(r => document.getElementById(`bench-bar-${r.db}`).style.width = `${(r.time/max)*100}%`);
        }
    </script>
</body>
</html>