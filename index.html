<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoSQL Laboratorio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { font-family: 'Fira Code', monospace; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-table th { background-color: #1e293b; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #1e293b; color: #cbd5e1; font-size: 0.875rem; }
        .custom-table tr:hover { background-color: #334155; }

        .bench-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <aside class="w-64 bg-black border-r border-slate-800 flex flex-col z-20">
        <div class="p-6 border-b border-slate-900 flex items-center gap-2">
            <h1 class="font-bold text-lg tracking-wider text-white">NoSQL <span class="text-blue-500">LAB</span></h1>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">General</div>
            <button onclick="showSection('welcome')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400 mb-1">üè† Inicio</button>
            <button onclick="showSection('benchmark')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-yellow-500 font-bold mb-4 border border-yellow-900/30">üöÄ Comparativa</button>

            <button onclick="loadData()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-green-400 font-bold border border-green-900/30 mb-4">
                üíæ <span>RECARGAR DATOS</span>
            </button>

            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">Operaciones</div>
            <button onclick="loadOperation('listar')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">üìú Listar Todo</button>
            <button onclick="loadOperation('leer')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">üëÅÔ∏è Leer ID</button>
            <button onclick="loadOperation('insertar')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">‚ûï Insertar</button>
            <button onclick="loadOperation('actualizar')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">‚úèÔ∏è Actualizar</button>
            <button onclick="loadOperation('borrar')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400 text-red-400">üóëÔ∏è Borrar</button>

            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mt-4 mb-2 px-2">Avanzado</div>
            <button onclick="loadOperation('rango')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">üîç Rango Ingresos</button>
            <button onclick="loadOperation('filtro')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">‚ö° Filtro Sector/Sexo</button>
            <button onclick="loadOperation('indexar')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400 hover:text-yellow-400">üè∑Ô∏è Re-Indexar</button>
            <button onclick="loadOperation('agregacion')" class="menu-btn w-full text-left px-4 py-2 rounded hover:bg-slate-900 text-slate-400">üìä Agregaci√≥n</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900">

        <div id="welcome-view" class="absolute inset-0 flex flex-col items-center justify-center text-center p-10 fade-in z-30 bg-slate-900">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent text-7xl font-extrabold mb-6">
                NoSQL Laboratorio
            </div>
            <p class="text-xl text-slate-400 max-w-2xl mb-10 leading-relaxed">
                Laboratorio interactivo. Comparativa de bases de datos NoSQL: MongoDB, Redis y Riak en tiempo real.
            </p>
            <div class="grid grid-cols-3 gap-6 w-full max-w-4xl">
                <div class="p-8 bg-slate-800/50 rounded-xl border border-slate-800 hover:border-green-500 transition">
                    <h3 class="text-green-400 font-bold text-2xl mb-2">MongoDB</h3>
                    <p class="text-sm text-slate-500">Documental BSON</p>
                </div>
                <div class="p-8 bg-slate-800/50 rounded-xl border border-slate-800 hover:border-red-500 transition">
                    <h3 class="text-red-400 font-bold text-2xl mb-2">Redis</h3>
                    <p class="text-sm text-slate-500">Key-Value</p>
                </div>
                <div class="p-8 bg-slate-800/50 rounded-xl border border-slate-800 hover:border-orange-500 transition">
                    <h3 class="text-orange-400 font-bold text-2xl mb-2">Riak</h3>
                    <p class="text-sm text-slate-500">Key-Value Distribuido</p>
                </div>
            </div>
        </div>

        <div id="benchmark-view" class="hidden absolute inset-0 flex flex-col p-8 fade-in z-30 bg-slate-900 overflow-y-auto">
            <h2 class="text-3xl font-bold text-white mb-2">üöÄ Comparativa de Rendimiento</h2>
            <p class="text-slate-400 mb-8">Ejecuta operaciones con par√°metros fijos en las 3 bases de datos.</p>

            <div class="grid grid-cols-4 gap-4 mb-10">
                <button onclick="runBenchmark('leer')" class="p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-left transition group">
                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Lectura Simple</div>
                    <div class="text-white font-bold group-hover:text-blue-400">Test: ID 123456789</div>
                </button>
                <button onclick="runBenchmark('insertar')" class="p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-left transition group">
                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Escritura</div>
                    <div class="text-white font-bold group-hover:text-blue-400">Test: ID 555888999</div>
                </button>
                <button onclick="runBenchmark('rango')" class="p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-left transition group">
                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Consulta Compleja</div>
                    <div class="text-white font-bold group-hover:text-blue-400">Test: 20k - 50k ‚Ç¨</div>
                </button>
                <button onclick="runBenchmark('agregacion')" class="p-4 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-left transition group">
                    <div class="text-xs text-slate-500 uppercase font-bold mb-1">Anal√≠tica</div>
                    <div class="text-white font-bold group-hover:text-blue-400">Test: Suma Sector 2</div>
                </button>
            </div>

            <div class="bg-black rounded-xl border border-slate-800 p-8 max-w-4xl w-full mx-auto">
                <h3 id="bench-title" class="text-xl font-bold text-white mb-6 border-b border-slate-800 pb-2">Resultados (ms)</h3>

                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="font-bold text-red-400 flex items-center gap-2">üî¥ REDIS</span>
                        <span id="bench-res-redis" class="text-white font-mono font-bold">0 ms</span>
                    </div>
                    <div class="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-800">
                        <div id="bench-bar-redis" class="h-full bg-red-600 bench-bar shadow-[0_0_10px_rgba(220,38,38,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="font-bold text-green-400 flex items-center gap-2">üü¢ MONGODB</span>
                        <span id="bench-res-mongo" class="text-white font-mono font-bold">0 ms</span>
                    </div>
                    <div class="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-800">
                        <div id="bench-bar-mongo" class="h-full bg-green-500 bench-bar shadow-[0_0_10px_rgba(34,197,94,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="font-bold text-orange-400 flex items-center gap-2">üü† RIAK</span>
                        <span id="bench-res-riak" class="text-white font-mono font-bold">0 ms</span>
                    </div>
                    <div class="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-800">
                        <div id="bench-bar-riak" class="h-full bg-orange-500 bench-bar shadow-[0_0_10px_rgba(249,115,22,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <div id="bench-winner" class="mt-8 text-center text-sm font-bold text-slate-500 italic h-6"></div>
            </div>
        </div>

        <div id="operation-view" class="hidden flex-1 flex flex-col h-full fade-in">
            <header class="bg-slate-950 border-b border-slate-800 p-4 flex justify-between items-center h-16 shadow-md z-10">
                <div><h2 id="op-title" class="text-xl font-bold text-white tracking-wide">OPERACI√ìN</h2></div>
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-800">
                    <button onclick="selectDB('mongo')" id="tab-mongo" class="tab-btn px-6 py-1 rounded text-sm font-bold text-slate-400 transition hover:text-white">MongoDB</button>
                    <button onclick="selectDB('redis')" id="tab-redis" class="tab-btn px-6 py-1 rounded text-sm font-bold text-slate-400 transition hover:text-white">Redis</button>
                    <button onclick="selectDB('riak')" id="tab-riak" class="tab-btn px-6 py-1 rounded text-sm font-bold text-slate-400 transition hover:text-white">Riak</button>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 flex flex-col border-r border-slate-800 bg-slate-900">
                    <div class="p-5 border-b border-slate-800 bg-slate-800/30">
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-4">üõ†Ô∏è Par√°metros</h3>
                        <div id="input-container" class="grid grid-cols-1 gap-4 mb-6"></div>

                        <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest mb-2">üíª Query Ejecutada</h3>
                        <div class="bg-black border border-slate-700 rounded p-3 mb-4 overflow-x-auto">
                            <pre><code id="query-code" class="text-xs font-mono text-purple-300">Esperando ejecuci√≥n...</code></pre>
                        </div>

                        <button onclick="runExecution()" id="btn-run" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg transition transform active:scale-[0.98]">
                            ‚ñ∂ EJECUTAR
                        </button>
                    </div>
                    <div class="flex-1 p-5 overflow-y-auto bg-black font-mono text-sm leading-relaxed border-t border-slate-800">
                        <div class="flex justify-between border-b border-slate-800 pb-2 mb-3">
                            <span class="text-slate-500 font-bold text-xs tracking-widest">TERMINAL</span>
                            <span id="exec-time" class="text-yellow-500 font-bold">0 ms</span>
                        </div>
                        <div id="console-output" class="space-y-2 text-green-400 font-medium"></div>
                    </div>
                </div>

                <div class="w-2/3 bg-slate-900 flex flex-col relative">
                    <div class="flex border-b border-slate-800 bg-slate-950 px-4 z-10 shadow-sm">
                        <button onclick="switchResultView('table')" id="view-btn-table" class="view-btn py-3 px-6 text-sm font-bold border-b-2 border-blue-500 text-white transition-colors">üìÖ Tabla</button>
                        <button onclick="switchResultView('json')" id="view-btn-json" class="view-btn py-3 px-6 text-sm font-bold border-b-2 border-transparent text-slate-500 hover:text-white transition-colors">{} JSON Raw</button>
                    </div>
                    <div class="flex-1 overflow-auto p-0 relative bg-slate-900/50">
                        <div id="result-table-container" class="p-0 w-full h-full absolute inset-0 overflow-auto">
                            <table class="w-full custom-table text-left border-collapse">
                                <thead id="table-head"></thead>
                                <tbody id="table-body"></tbody>
                            </table>
                            <div id="table-empty" class="hidden flex flex-col items-center justify-center h-full text-slate-500">
                                <div class="text-4xl mb-2">‚àÖ</div>
                                <div>Sin resultados</div>
                            </div>
                        </div>
                        <div id="result-json-container" class="hidden p-4 w-full h-full absolute inset-0 overflow-auto bg-[#1e1e1e]">
                            <pre><code id="json-output" class="language-json text-sm font-mono"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8000";
        let currentOp = 'listar';
        let currentDB = 'mongo';

        const INPUTS = {
            listar: [],
            leer: [{id:'dni', label:'DNI', val:'555888999'}],
            insertar: [{id:'dni',label:'DNI',val:'555888999'}, {id:'nombre',label:'Nombre',val:'TestUser'}, {id:'ingresos',label:'Ingresos',val:25000}, {id:'sector',label:'Sector',val:3}, {id:'sexo',label:'Sexo',val:'M'}],
            actualizar: [{id:'dni', label:'DNI', val:'555888999'}, {id:'ingresos', label:'Nuevos Ingresos', val:45000}],
            borrar: [{id:'dni', label:'DNI', val:'555888999'}],
            rango: [{id:'min_val', label:'Min ‚Ç¨', val:20000}, {id:'max_val', label:'Max ‚Ç¨', val:50000}],
            filtro: [{id:'sector', label:'Sector', val:2}, {id:'sexo', label:'Sexo', val:'M'}],
            agregacion: [{id:'sector', label:'Sector', val:2}],
            indexar: []
        };

        function showSection(section) {
            ['welcome-view', 'operation-view', 'benchmark-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(section + '-view').classList.remove('hidden');
        }

        function loadOperation(op) {
            showSection('operation');
            currentOp = op;
            document.getElementById('op-title').innerText = op.toUpperCase();
            renderInputs(INPUTS[op] || []);
        }

        function renderInputs(inputs) {
            const container = document.getElementById('input-container');
            container.innerHTML = '';
            if(!inputs.length) container.innerHTML = '<div class="text-xs text-slate-600 italic text-center py-4">Sin par√°metros necesarios</div>';
            inputs.forEach(inp => {
                container.innerHTML += `
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">${inp.label}</label>
                        <input id="input-${inp.id}" value="${inp.val}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
                    </div>`;
            });
        }

        function selectDB(db) {
            currentDB = db;
            document.querySelectorAll('.tab-btn').forEach(b => {
                const isActive = b.id === `tab-${db}`;
                b.classList.toggle('bg-blue-600', isActive);
                b.classList.toggle('text-white', isActive);
                b.classList.toggle('text-slate-400', !isActive);
            });
        }

        function switchResultView(view) {
            document.getElementById('result-table-container').classList.toggle('hidden', view !== 'table');
            document.getElementById('result-json-container').classList.toggle('hidden', view !== 'json');

            const btnTable = document.getElementById('view-btn-table');
            const btnJson = document.getElementById('view-btn-json');

            if(view === 'table') {
                btnTable.classList.add('border-blue-500', 'text-white');
                btnTable.classList.remove('border-transparent', 'text-slate-500');
                btnJson.classList.remove('border-blue-500', 'text-white');
                btnJson.classList.add('border-transparent', 'text-slate-500');
            } else {
                btnJson.classList.add('border-blue-500', 'text-white');
                btnJson.classList.remove('border-transparent', 'text-slate-500');
                btnTable.classList.remove('border-blue-500', 'text-white');
                btnTable.classList.add('border-transparent', 'text-slate-500');
            }
        }

        async function loadData() {
            if(!confirm("ATENCI√ìN: Se reiniciar√°n las 3 bases de datos. ¬øContinuar?")) return;
            const res = await fetch(`${API_URL}/load-data`);
            alert((await res.json()).msg);
        }

        function renderTable(data) {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            const emptyMsg = document.getElementById('table-empty');

            thead.innerHTML = ''; tbody.innerHTML = '';

            let arr = Array.isArray(data) ? data : [data];
            arr = arr.filter(item => item !== null && item !== undefined && Object.keys(item).length > 0);

            if (arr.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            const headers = Object.keys(arr[0]);
            let headerHTML = '<tr>';
            headers.forEach(h => headerHTML += `<th class="whitespace-nowrap">${h}</th>`);
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            arr.forEach(row => {
                let tr = '<tr class="transition-colors">';
                headers.forEach(h => {
                    let val = row[h];
                    if(typeof val === 'object' && val !== null) val = JSON.stringify(val);
                    if(val === null || val === undefined) val = '-';
                    tr += `<td class="whitespace-nowrap">${val}</td>`;
                });
                tr += '</tr>';
                tbody.innerHTML += tr;
            });
        }

        async function runExecution() {
            const params = new URLSearchParams();
            (INPUTS[currentOp] || []).forEach(inp => params.append(inp.id, document.getElementById(`input-${inp.id}`).value));

            const consoleDiv = document.getElementById('console-output');
            const queryCodeDiv = document.getElementById('query-code');

            consoleDiv.innerHTML = '<span class="text-yellow-500 animate-pulse">‚è≥ Ejecutando petici√≥n...</span>';
            queryCodeDiv.innerText = '...';

            try {
                const res = await fetch(`${API_URL}/execute/${currentOp}/${currentDB}?${params}`);
                const json = await res.json();

                consoleDiv.innerHTML = '';
                json.trace.forEach(l => consoleDiv.innerHTML += `<div class="py-0.5">${l}</div>`);
                document.getElementById('exec-time').innerText = `${json.time_ms} ms`;

                queryCodeDiv.textContent = json.query_str || "Operaci√≥n interna (sin query est√°ndar)";
                hljs.highlightElement(queryCodeDiv);

                document.getElementById('json-output').textContent = JSON.stringify(json.data, null, 2);
                hljs.highlightElement(document.getElementById('json-output'));
                renderTable(json.data);
            } catch (e) {
                consoleDiv.innerHTML = `<span class="text-red-500 font-bold">‚ùå Error: ${e.message}</span>`;
            }
        }

        async function runBenchmark(op) {
            ['redis','mongo','riak'].forEach(db => {
                document.getElementById(`bench-bar-${db}`).style.width = '0%';
                document.getElementById(`bench-res-${db}`).innerText = 'Running...';
                document.getElementById(`bench-res-${db}`).classList.add('animate-pulse');
            });
            document.getElementById('bench-winner').innerText = '';

            let paramsObj = {};
            if (op === 'leer') {
                paramsObj = { dni: '123456789' };
            } else if (op === 'insertar') {
                paramsObj = { dni: '555888999', nombre: 'BenchmarkUser', ingresos: 35000, sector: 2, sexo: 'M' };
            } else if (op === 'rango') {
                paramsObj = { min_val: 20000, max_val: 50000 };
            } else if (op === 'agregacion') {
                paramsObj = { sector: 2 };
            }

            const params = new URLSearchParams(paramsObj);
            const times = {};

            for (const db of ['redis', 'mongo', 'riak']) {
                try {
                    await new Promise(r => setTimeout(r, 100));
                    const res = await fetch(`${API_URL}/execute/${op}/${db}?${params}`);
                    const data = await res.json();
                    times[db] = data.time_ms;
                } catch(e) {
                    console.error(`Error en ${db}:`, e);
                    times[db] = 9999;
                }

                document.getElementById(`bench-res-${db}`).innerText = times[db] + ' ms';
                document.getElementById(`bench-res-${db}`).classList.remove('animate-pulse');
            }

            const timesArr = Object.values(times);
            const maxTime = Math.max(...timesArr);
            const minTime = Math.min(...timesArr);

            for (const db of ['redis', 'mongo', 'riak']) {
                let percentage = (times[db] / maxTime) * 100;
                if (percentage < 1) percentage = 1;
                document.getElementById(`bench-bar-${db}`).style.width = `${percentage}%`;
            }

            const winner = Object.keys(times).reduce((a, b) => times[a] < times[b] ? a : b);
            const diff = minTime > 0 ? (maxTime / minTime).toFixed(1) : "‚àû";

            document.getElementById('bench-winner').innerHTML =
                `Ganador: <span class="uppercase text-white font-bold">${winner}</span>`;
        }
    </script>
</body>
</html>