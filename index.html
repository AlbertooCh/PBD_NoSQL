<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoSQL Benchmark: Mongo vs Redis vs Riak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 1s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <!-- MEN√ö LATERAL -->
    <aside class="w-64 bg-black border-r border-slate-800 flex flex-col z-20">
        <div class="p-6 border-b border-slate-900 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
            <h1 class="font-bold text-lg tracking-wider text-white">NoSQL <span class="text-blue-500">BENCH</span></h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">General</div>
            <button onclick="showSection('welcome')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè† <span>Inicio</span>
            </button>
            <button onclick="loadData()" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-green-400">
                üíæ <span>Cargar Datos</span>
            </button>
            <button onclick="showSection('benchmark')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white hover:text-yellow-400 border border-transparent hover:border-yellow-900">
                üöÄ <span>Comparativa (Benchmark)</span>
            </button>

            <div class="mt-6 text-xs font-bold text-slate-600 uppercase tracking-widest mb-2 px-2">Operaciones</div>
            <button onclick="loadOperation('indexar')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üè∑Ô∏è <span>Indexar Datos (2i)</span>
            </button>
            <button onclick="loadOperation('rango')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üîç <span>B√∫squeda Rango</span>
            </button>
            <button onclick="loadOperation('filtro')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                ‚ö° <span>Filtro Complejo</span>
            </button>
            <button onclick="loadOperation('agregacion')" class="menu-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-900 transition flex items-center gap-3 text-slate-400 hover:text-white">
                üìä <span>Agregaci√≥n</span>
            </button>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-900">

        <!-- VISTA: BIENVENIDA -->
        <div id="welcome-view" class="absolute inset-0 flex flex-col items-center justify-center text-center p-10 fade-in z-10">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent text-7xl font-extrabold mb-6">
                NoSQL Battle Arena
            </div>
            <p class="text-xl text-slate-400 max-w-2xl mb-10">
                Entorno interactivo para pruebas de rendimiento y sintaxis.
            </p>
            <div class="grid grid-cols-3 gap-6 w-full max-w-5xl">
                <div class="p-8 bg-slate-800/50 rounded-2xl border border-slate-800 hover:border-green-500/50 transition duration-300">
                    <h3 class="text-green-400 font-bold text-2xl mb-2">MongoDB</h3>
                    <p class="text-sm text-slate-500">Documental. Equilibrio entre flexibilidad y velocidad.</p>
                </div>
                <div class="p-8 bg-slate-800/50 rounded-2xl border border-slate-800 hover:border-red-500/50 transition duration-300">
                    <h3 class="text-red-400 font-bold text-2xl mb-2">Redis</h3>
                    <p class="text-sm text-slate-500">In-Memory. Velocidad extrema, persistencia opcional.</p>
                </div>
                <div class="p-8 bg-slate-800/50 rounded-2xl border border-slate-800 hover:border-orange-500/50 transition duration-300">
                    <h3 class="text-orange-400 font-bold text-2xl mb-2">Riak KV</h3>
                    <p class="text-sm text-slate-500">Distribuido. Alta disponibilidad y tolerancia a fallos.</p>
                </div>
            </div>
        </div>

        <!-- VISTA: BENCHMARK -->
        <div id="benchmark-view" class="hidden absolute inset-0 flex flex-col p-8 fade-in z-10 bg-slate-900">
            <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
                <span>üöÄ</span> Test de Rendimiento
            </h2>
            <div class="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700">
                <label class="block text-sm text-slate-400 mb-2">Selecciona la prueba a ejecutar:</label>
                <div class="flex gap-4">
                    <button onclick="runBenchmark('rango')" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white font-bold transition">B√∫squeda Rango</button>
                    <button onclick="runBenchmark('filtro')" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white font-bold transition">Filtro Complejo</button>
                    <button onclick="runBenchmark('agregacion')" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white font-bold transition">Agregaci√≥n</button>
                </div>
            </div>
            <div class="flex-1 space-y-6">
                <!-- REDIS BAR -->
                <div class="relative">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold text-red-400">REDIS STACK</span>
                        <span id="bench-time-redis" class="text-slate-400">0 ms</span>
                    </div>
                    <div class="h-8 bg-slate-800 rounded-full overflow-hidden">
                        <div id="bench-bar-redis" class="h-full bg-red-500 progress-bar w-0 relative flex items-center justify-end px-2"></div>
                    </div>
                </div>
                <!-- MONGO BAR -->
                <div class="relative">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold text-green-400">MONGODB</span>
                        <span id="bench-time-mongo" class="text-slate-400">0 ms</span>
                    </div>
                    <div class="h-8 bg-slate-800 rounded-full overflow-hidden">
                        <div id="bench-bar-mongo" class="h-full bg-green-500 progress-bar w-0"></div>
                    </div>
                </div>
                <!-- RIAK BAR -->
                <div class="relative">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold text-orange-400">RIAK KV</span>
                        <span id="bench-time-riak" class="text-slate-400">0 ms</span>
                    </div>
                    <div class="h-8 bg-slate-800 rounded-full overflow-hidden">
                        <div id="bench-bar-riak" class="h-full bg-orange-500 progress-bar w-0"></div>
                    </div>
                </div>
                <div id="bench-log" class="mt-8 p-4 bg-black rounded font-mono text-xs text-slate-500 h-32 overflow-auto border border-slate-800">
                    // Logs del benchmark...
                </div>
            </div>
        </div>

        <!-- VISTA: OPERACIONES -->
        <div id="operation-view" class="hidden flex-1 flex flex-col h-full">
            <header class="bg-slate-950 border-b border-slate-800 p-6 flex justify-between items-center">
                <div>
                    <h2 id="op-title" class="text-2xl font-bold text-white">Operaci√≥n</h2>
                    <p id="op-subtitle" class="text-slate-400 text-sm">Descripci√≥n...</p>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-800">
                    <button onclick="selectDB('mongo')" id="tab-mongo" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">MongoDB</button>
                    <button onclick="selectDB('redis')" id="tab-redis" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Redis</button>
                    <button onclick="selectDB('riak')" id="tab-riak" class="tab-btn px-4 py-2 rounded-md text-sm font-bold text-slate-400 transition">Riak</button>
                </div>
            </header>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 flex flex-col border-r border-slate-800 bg-slate-900">
                    <div class="p-6 border-b border-slate-800 bg-slate-800/30">
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-3">üõ†Ô∏è Configurar Par√°metros</h3>
                        <div id="input-container" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <h3 class="text-slate-500 font-bold uppercase text-xs tracking-widest mb-2">Explicaci√≥n & C√≥digo:</h3>
                        <p id="op-explanation" class="text-slate-300 mb-4 text-sm leading-relaxed"></p>
                        <div class="relative group">
                            <pre><code id="op-code" class="language-python rounded-lg bg-black p-4 text-sm border border-slate-700 shadow-inner"></code></pre>
                        </div>
                        <button onclick="runExecution()" id="btn-run" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98] flex justify-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Ejecutar en <span id="btn-db-name">...</span>
                        </button>
                    </div>
                </div>
                <div class="w-1/2 bg-black flex flex-col font-mono text-sm">
                    <div class="bg-slate-900 text-slate-400 px-4 py-2 text-xs border-b border-slate-800 flex justify-between">
                        <span>TERMINAL DE SALIDA</span>
                        <span id="exec-time" class="text-yellow-500"></span>
                    </div>
                    <div id="console-output" class="flex-1 p-4 overflow-y-auto space-y-1 text-green-400 font-light"></div>
                    <div class="h-1/3 border-t border-slate-800 bg-slate-900/50 flex flex-col">
                        <div class="bg-slate-900 text-slate-400 px-4 py-1 text-xs border-b border-slate-800">RESULTADO (JSON)</div>
                        <div id="json-output" class="flex-1 p-4 overflow-auto text-blue-300 text-xs whitespace-pre">{}</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = "http://localhost:8000";
        let currentOp = null;
        let currentDB = 'mongo';

        const KNOWLEDGE = {
            indexar: {
                title: "Indexar Datos (2i)",
                subtitle: "A√±adir metadatos a objetos existentes para permitir b√∫squedas.",
                inputs: [],
                mongo: { desc: "Creaci√≥n de √≠ndices B-Tree.", code: `db.poblacion.createIndex({ ingresos: 1 })\ndb.poblacion.createIndex({ sector: 1 })` },
                redis: { desc: "Creaci√≥n de √≠ndice RediSearch.", code: `FT.CREATE idx:poblacion ON HASH PREFIX 1 "poblacion:" SCHEMA ...` },
                riak: {
                    desc: "Recorrer las claves y a√±adir headers 'x-riak-index-...' (PUT).",
                    code: `def indexar_datos_existentes():\n  keys = get_keys('poblacion')\n  for k in keys:\n    data = get_object('poblacion', k)\n    if data:\n      mis_indices = {\n        'ingresos_int': data['ingresos'],\n        'sector_int': data['sector'],\n        'sexo_bin': data['sexo']\n      }\n      store_object_with_indexes('poblacion', k, data, mis_indices)`
                }
            },
            rango: {
                title: "B√∫squeda por Rango",
                subtitle: "Encontrar registros entre dos valores num√©ricos.",
                inputs: [
                    {id: 'min_val', label: 'Ingreso M√≠nimo (‚Ç¨)', type: 'number', val: 20000},
                    {id: 'max_val', label: 'Ingreso M√°ximo (‚Ç¨)', type: 'number', val: 50000}
                ],
                mongo: { desc: "Operadores $gte y $lte.", code: `db.poblacion.find({\n  ingresos: { $gte: {{min_val}}, $lte: {{max_val}} }\n})` },
                redis: { desc: "RediSearch query num√©rica.", code: `FT.SEARCH idx:poblacion "@ingresos:[{{min_val}} {{max_val}}]"` },
                riak: {
                    desc: "Uso de query_2i_range sobre 'ingresos_int'.",
                    code: `def buscar_por_ingresos(min_ing={{min_val}}, max_ing={{max_val}}):\n  # 1. Obtenemos claves\n  keys = query_2i_range('poblacion', 'ingresos_int', min_ing, max_ing)\n  \n  # 2. Obtenemos objetos\n  for k in keys:\n    d = get_object('poblacion', k)\n    print(d)`
                }
            },
            filtro: {
                title: "Filtro Complejo",
                subtitle: "Filtrar por Sector y Sexo simult√°neamente.",
                inputs: [
                    {id: 'sector', label: 'Sector ID (1-4)', type: 'number', val: 2},
                    {id: 'sexo', label: 'Sexo (H/M)', type: 'select', val: 'M', opts: ['H', 'M']}
                ],
                mongo: { desc: "Consulta compuesta nativa.", code: `db.poblacion.find({ sector: {{sector}}, sexo: "{{sexo}}" })` },
                redis: { desc: "Intersecci√≥n de √≠ndices.", code: `FT.SEARCH idx:poblacion "@sector:[{{sector}} {{sector}}] @sexo:{{{sexo}}}"` },
                riak: {
                    desc: "Filtro primario en Riak (Sector) + Filtro secundario en App (Sexo).",
                    code: `def filtrar_por_sector_sexo(sector={{sector}}, sexo='{{sexo}}'):\n  # 1. Filtro primario eficiente\n  keys = query_2i_exact('poblacion', 'sector_int', sector)\n\n  # 2. Filtro secundario: Application Side\n  for k in keys:\n    d = get_object('poblacion', k)\n    if d and d['sexo'] == sexo:\n      print(d)`
                }
            },
            agregacion: {
                title: "Agregaci√≥n",
                subtitle: "Sumar ingresos de un sector.",
                inputs: [
                    {id: 'sector', label: 'Sector ID (1-4)', type: 'number', val: 2}
                ],
                mongo: { desc: "Aggregation Pipeline.", code: `db.poblacion.aggregate([...])` },
                redis: { desc: "RediSearch Aggregation.", code: `FT.AGGREGATE ...` },
                riak: {
                    desc: "Descarga de claves y suma en cliente (Application Side Aggregation).",
                    code: `def guardar_resumen_sector():\n  keys = get_keys('poblacion')\n  resumen = {}\n  for k in keys:\n    p = get_object('poblacion', k)\n    if p and str(p['sector']) == '{{sector}}':\n      resumen.setdefault(str(p['sector']), 0)\n      resumen[str(p['sector'])] += p['ingresos']\n  store_object_with_indexes('resumenes', ...)`
                }
            }
        };

        function showSection(id) {
            ['welcome-view', 'benchmark-view', 'operation-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id + '-view').classList.remove('hidden');
        }

        async function loadData() {
            if(!confirm("Se borrar√°n y recargar√°n datos. ¬øSeguro?")) return;
            try {
                const res = await fetch(`${API_URL}/load-data`);
                const data = await res.json();
                alert(data.msg || "Datos cargados");
            } catch(e) { alert("Error conectando al backend"); }
        }

        function loadOperation(op) {
            currentOp = op;
            showSection('operation');
            const info = KNOWLEDGE[op];
            document.getElementById('op-title').innerText = info.title;
            document.getElementById('op-subtitle').innerText = info.subtitle;
            renderInputs(info.inputs);
            selectDB(currentDB);
        }

        function renderInputs(inputs) {
            const container = document.getElementById('input-container');
            container.innerHTML = '';
            if(!inputs || inputs.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-xs italic">Sin par√°metros configurables</div>';
                return;
            }
            inputs.forEach(inp => {
                const div = document.createElement('div');
                div.className = "flex flex-col";
                const label = document.createElement('label');
                label.className = "text-xs text-slate-400 mb-1 font-bold";
                label.innerText = inp.label;
                let field;
                if(inp.type === 'select') {
                    field = document.createElement('select');
                    inp.opts.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o; opt.innerText = o;
                        if(o === inp.val) opt.selected = true;
                        field.appendChild(opt);
                    });
                } else {
                    field = document.createElement('input');
                    field.type = inp.type;
                    field.value = inp.val;
                }
                field.id = `input-${inp.id}`;
                field.className = "bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none transition";
                field.addEventListener('input', () => updateCodeView());
                field.addEventListener('change', () => updateCodeView());
                div.appendChild(label);
                div.appendChild(field);
                container.appendChild(div);
            });
        }

        function getParamValues() {
            if(!currentOp || !KNOWLEDGE[currentOp].inputs) return {};
            const vals = {};
            KNOWLEDGE[currentOp].inputs.forEach(inp => {
                vals[inp.id] = document.getElementById(`input-${inp.id}`).value;
            });
            return vals;
        }

        function updateCodeView() {
            const info = KNOWLEDGE[currentOp][currentDB];
            let code = info.code;
            const params = getParamValues();
            for (const [key, val] of Object.entries(params)) {
                code = code.replaceAll(`{{${key}}}`, val);
            }
            document.getElementById('op-explanation').innerText = info.desc;
            const codeEl = document.getElementById('op-code');
            codeEl.textContent = code;
            hljs.highlightElement(codeEl);
        }

        function selectDB(db) {
            currentDB = db;
            document.querySelectorAll('.tab-btn').forEach(b => {
                if(b.id === `tab-${db}`) b.classList.add('bg-blue-600', 'text-white');
                else b.classList.remove('bg-blue-600', 'text-white');
            });
            document.getElementById('btn-db-name').innerText = db.toUpperCase();
            updateCodeView();
            document.getElementById('console-output').innerHTML = '';
            document.getElementById('json-output').innerText = '{}';
            document.getElementById('exec-time').innerText = '';
        }

        async function runExecution() {
            const params = new URLSearchParams(getParamValues());
            const url = `${API_URL}/execute/${currentOp}/${currentDB}?${params}`;
            document.getElementById('console-output').innerHTML = '<div class="text-yellow-500 animate-pulse">‚è≥ Ejecutando...</div>';
            try {
                const res = await fetch(url);
                const data = await res.json();
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerHTML = '';
                data.trace.forEach(log => {
                    const div = document.createElement('div');
                    div.innerText = log;
                    consoleDiv.appendChild(div);
                });
                document.getElementById('json-output').innerText = JSON.stringify(data.data, null, 2);
                document.getElementById('exec-time').innerText = `${data.time_ms} ms`;
            } catch(e) { alert("Error de conexi√≥n"); }
        }

        async function runBenchmark(op) {
            const logDiv = document.getElementById('bench-log');
            logDiv.innerHTML = `<div>üèÅ Iniciando carrera para: ${op.toUpperCase()}</div>`;
            ['redis', 'mongo', 'riak'].forEach(db => {
                document.getElementById(`bench-bar-${db}`).style.width = '0%';
                document.getElementById(`bench-time-${db}`).innerText = '...';
            });
            const params = new URLSearchParams({ min_val: 20000, max_val: 50000, sector: 2, sexo: 'M' });
            const dbs = ['redis', 'mongo', 'riak'];
            const results = [];
            for (const db of dbs) {
                logDiv.innerHTML += `<div>‚è≥ Corriendo ${db}...</div>`;
                const res = await fetch(`${API_URL}/execute/${op}/${db}?${params}`);
                const data = await res.json();
                results.push({ db, time: data.time_ms });
                document.getElementById(`bench-time-${db}`).innerText = `${data.time_ms} ms`;
            }
            const maxTime = Math.max(...results.map(r => r.time));
            results.forEach(r => {
                const pct = (r.time / maxTime) * 100;
                document.getElementById(`bench-bar-${r.db}`).style.width = `${pct}%`;
            });
        }
    </script>
</body>
</html>